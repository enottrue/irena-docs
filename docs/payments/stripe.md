# Документация по интеграции Stripe

## Обзор
Этот документ описывает интеграцию платежной системы Stripe в нашу CRM-систему, включая конфигурацию, платежные потоки и обработку успешных/неуспешных платежей.

## Конфигурация
Интеграция Stripe настраивается в файле `src/modules/Acquire/config.json` с отдельными настройками для тестового и боевого окружения:

```json
{
  "stripe": {
    "test": {
      "secretKey": "sk_test_...",
      "successUrl": "https://store.tibracelets.ru/thank-you",
      "cancelUrl": "https://store.tibracelets.ru/failed/"
    },
    "live": {
      "secretKey": "rk_live_...",
      "successUrl": "https://store.tibracelets.ru/thank-you",
      "cancelUrl": "https://store.tibracelets.ru/failed/"
    }
  }
}
```

## Платежные потоки

### 1. Стандартный платежный поток
- **URL успешной оплаты**: `https://store.tibracelets.ru/thank-you`
- **URL отмены/ошибки**: `https://store.tibracelets.ru/failed/`
- Используется для стандартных покупок товаров

### 2. Кастомные потоки для воронок продаж
Система поддерживает различные URL-адреса успеха и ошибки в зависимости от воронки продаж:
- Каждая воронка может иметь свои собственные страницы успеха и ошибки
- URL-адреса динамически устанавливаются при создании платежной сессии
- Это позволяет настраивать опыт после оплаты в зависимости от пути клиента

## Детали реализации

### Создание платежной сессии
1. Система определяет текущую воронку продаж
2. Определяет соответствующие URL-адреса успеха/ошибки
3. Создает платежную сессию Stripe с настроенными URL-адресами
4. Перенаправляет клиента на платежную страницу Stripe

### Обработка после оплаты
1. **Успешная оплата**:
   - Клиент перенаправляется на страницу успеха, специфичную для воронки
   - Система записывает успешный платеж
   - Заказ отмечается как оплаченный
   - Клиент получает подтверждение

2. **Неуспешная/отмененная оплата**:
   - Клиент перенаправляется на страницу ошибки, специфичную для воронки
   - Система записывает неудачную попытку оплаты
   - Клиент может повторить попытку оплаты при желании

## Соображения безопасности
- Тестовое и боевое окружение используют разные API-ключи
- Секретные ключи хранятся в конфигурации
- Все платежные данные обрабатываются через защищенную инфраструктуру Stripe
- В нашей системе не хранится чувствительная платежная информация

## Тестирование
- Используйте тестовые API-ключи для разработки и тестирования
- Доступны тестовые карты для различных сценариев:
  - Успешная оплата: 4242 4242 4242 4242
  - Неуспешная оплата: 4000 0000 0000 0002
  - 3D Secure: 4000 0000 0000 3220

## Распространенные проблемы и решения
1. **Истечение срока действия платежной сессии**
   - Сессии истекают через 24 часа
   - Создайте новую сессию при истечении срока

2. **Настройка URL-адресов**
   - Убедитесь, что URL-адреса успеха/ошибки доступны
   - В продакшене URL-адреса должны быть HTTPS
   - Локальное тестирование может использовать HTTP

3. **Обработка вебхуков**
   - Система прослушивает вебхуки Stripe
   - Обрабатывает обновления статуса платежа
   - Обновляет статус заказа соответственно

## Поддержка
При проблемах с интеграцией Stripe:
1. Проверьте статус платежа в панели управления Stripe
2. Просмотрите логи вебхуков
3. Проверьте конфигурации воронок
4. Обратитесь к команде разработки, если проблемы сохраняются 